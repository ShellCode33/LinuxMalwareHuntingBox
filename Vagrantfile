# -*- mode: ruby -*-

Vagrant.configure("2") do |config|
  config.vm.define "MyBox-Cuckoo"
  config.vm.box = "generic/ubuntu1804"
  config.vm.hostname = "cuckoo"
  config.vm.network :private_network, ip: "192.168.0.42"

  config.vm.provider :virtualbox do |vb|
    vb.name = "MyBox-Cuckoo"
    vb.customize [
      "modifyvm", :id,
      "--cpuexecutioncap", "50",
      "--memory", "512",
    ]
  end

  # From there : https://cuckoo.sh/docs/installation/guest/linux.html#preparing-x32-x64-ubuntu-18-04-linux-guests
  config.vm.provision "shell", privileged: true, inline: <<-SCRIPT
    cd /root

    wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/cuckoo/data/agent/agent.py
    (crontab -l 2>/dev/null; echo "@reboot python2.7 /root/agent.py") | crontab -

    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C8CAB6595FDFF622

    codename=$(lsb_release -cs)
    tee /etc/apt/sources.list.d/ddebs.list << EOF
      deb http://ddebs.ubuntu.com/ ${codename}          main restricted universe multiverse
      #deb http://ddebs.ubuntu.com/ ${codename}-security main restricted universe multiverse
      deb http://ddebs.ubuntu.com/ ${codename}-updates  main restricted universe multiverse
      deb http://ddebs.ubuntu.com/ ${codename}-proposed main restricted universe multiverse
EOF

    apt update
    apt-get install -y python2.7 systemtap gcc patch linux-headers-$(uname -r) linux-image-$(uname -r)-dbgsym

    wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/expand_execve_envp.patch
    wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/escape_delimiters.patch
    patch /usr/share/systemtap/tapset/linux/sysc_execve.stp < expand_execve_envp.patch
    patch /usr/share/systemtap/tapset/uconversions.stp < escape_delimiters.patch
    
    wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/strace.stp
    stap -p4 -r $(uname -r) strace.stp -m stap_MyBox -v
    
    mkdir .cuckoo
    mv stap_MyBox.ko .cuckoo
    
    ufw disable
    timedatectl set-ntp off
  SCRIPT

end

